"use strict";function load(e,t=""){return loadItem(namespace,e,t)}function save(e,t){saveItem(namespace,e,t)}function partySort(e){let t=[];return settings.partySort["when"+jobList.find(t=>t.ID.toString()===e.find(e=>e.id!==charID).job.toString()).Role].split(">").forEach(e=>t.push(...settings.partySort[e])),e.sort((e,s)=>parseInt(t.indexOf(baseClass[e.job].toString()))-parseInt(t.indexOf(baseClass[s.job].toString())))}function handle(){document.querySelector("main").innerHTML="";for(let e=0;e<party.length;e++){const t=party[e];if(void 0===t)break;settings.watchs.find(e=>e.job===t.job.toString()).watch.forEach(s=>{let n=actions.find(e=>e.ID===s.id),r=document.createElement("article");r.style.position="absolute",r.style.top=`${.8*(parseInt(s.top)+50*e)}px`,r.style.right=.8*parseInt(s.right)+"px",r.style.width="48px",r.style.height=r.style.width,r.style.lineHeight=r.style.width,r.style.transform=`scale(${.8*s.scale})`,setTimeout(()=>{"TRUE"!==n.IsRoleAction&&parseInt(n.ClassJobLevel)>parseInt(levels[t.id])&&(r.style.opacity="0.5")},1e3),r.style.fontSize=settings.style.fontSize+"px",r.setAttribute("name",e+"-"+n.ID);let i=n.Recast100ms instanceof Function?n.Recast100ms(levels[t.id]?levels[t.id]:0)/10:n.Recast100ms/10;r.setAttribute("reset100ms",i);let a=n.MaxCharges instanceof Function?n.MaxCharges(levels[t.id]?levels[t.id]:0):n.MaxCharges;r.style.background=`\n        url(),\n        url(./resources/${settings.style.skin}.png),\n        url(https://cafemaker.wakingsands.com/i/${n.Url}.png) center / 40px 40px no-repeat `,a>0&&(r.innerText=a,r.style.textShadow="-1px 0 3px rgb(197, 73, 0), 0 1px 3px rgb(197, 73, 0), 1px 0 3px rgb(197, 73, 0), 0 -1px 3px rgb(197, 73, 0)",r.style.fontSize=.8*parseInt(r.style.fontSize)+"px",r.style.padding="15px 0px 0px 30px"),r.use=function(){if("true"===settings.ttsOn&&TTS(settings.tts[n.ID]),r.style.opacity="1","0"===a){clearInterval(r.timer);let e=`url(./resources/${settings.style.skin+n.ActionCategory}.png)`,t=r.style.background.split(",");t[0]=`${e} 0px 0px/ 432px 432px`,r.style.background=t.join(",");let s=i;r.timer=setInterval(()=>{let n=1-s/i,a=Math.floor(81*n%9),o=Math.floor(9*n);8!==a||8!==o?(s-=settings.style.refreshRate/1e3,r.innerText=Math.round(s),t[0]=`${e} ${-48*a}px ${-48*o}px / 432px 432px`,r.style.background=t.join(",")):(clearInterval(r.timer),r.innerText="",t[0]="url()",r.style.background=t.join(","))},settings.style.refreshRate)}else{r.innerText=parseInt(r.innerText)-1;let e=r.style.background.split(",");e[1]=`url(./resources/${"0"!==r.innerText?settings.style.skin:"0charges"}.png)`,r.style.background=e.join(","),r.style.color="0"===r.innerText?"rgb(255,100,100)":"white";let t=i;r.timer||(r.timer=setInterval(()=>{let s=1-t/i,n=Math.floor(81*s%9),o=Math.floor(9*s);8!==n||8!==o?(t-=settings.style.refreshRate/1e3,e[0]=`url(./resources/charges.png) ${-48*n}px ${-48*o}px / 432px 432px`,e[1]=`url(./resources/${"0"!==r.innerText?settings.style.skin:"0charges"}.png)`,r.style.background=e.join(",")):(clearInterval(r.timer),r.timer=void 0,r.innerText=parseInt(r.innerText)+1,e[0]="url(./resources/charges.png) 0px 0px/ 432px 432px",e[1]=`url(./resources/${"0"!==r.innerText?settings.style.skin:"0charges"}.png)`,r.style.background=e.join(","),r.innerText===a?e[1]=`url(./resources/${settings.style.skin}.png)`:(r.innerText=parseInt(r.innerText)+1,r.use()))},settings.style.refreshRate))}},document.querySelector("main").appendChild(r)})}}import{loadItem,saveItem}from"../../../resources/localStorage.min.js";import{TTS}from"../../../resources/TTS.js";import{actions}from"./actions.min.js";import{compareSame}from"./compareSameGroup.min.js";import{defaultSettings}from"./defaultSettings.min.js";import{jobList}from"./job.min.js";let settings,namespace="TeamWatch3",baseClass={1:19,2:20,3:21,4:22,5:23,6:24,7:25,26:27,29:30,19:19,21:21,32:32,37:37,24:24,28:28,33:33,20:20,22:22,30:30,34:34,23:23,31:31,38:38,25:25,27:27,35:35,36:36},charID="10000021",party=[],levels={};(function(){function e(e){let t=[];for(const s in e){e[s].reverse();let n={};n.job=s;let r=[],i=0;for(const t of e[s])""!==t&&r.push({id:t,scale:"1",top:"0px",right:44*i+"px"}),i++;n.watch=r,t.push(n)}return t}settings=Object.assign(defaultSettings,load("settings",{}));let t=localStorage.getItem("teamWatch");t&&!localStorage.getItem("TeamWatch3")&&(console.log("从旧版本中继承了数据"),t=JSON.parse(t),settings=Object.assign(defaultSettings,{watchs:e(t.watch)}),settings.ttsOn=t.TTSOn||settings.ttsOn,settings.tts=t.TTS||settings.tts,settings.style.fontSize=t.settings.fontSize||settings.style.fontSize,save("settings",settings))})(),addOverlayListener("ChangePrimaryPlayer",e=>charID=e.charID.toString(16).toUpperCase()),addOverlayListener("onLogEvent",e=>{for(const t of e.detail.logs){let e=t.match(/^.{15}03:(?<id>1.{7}):Added new combatant .+? Job:.+? Level: (?<level>\d+) Max HP/),s=t.match(/^.{15}04:(?<id>1.{7}):/),n=t.match(/^.{15}1[56]:(?<id>1.{7}):[^:]+:(?<ability>[^:]+):.+:0$/);if(e)levels[e.groups.id]=e.groups.level;else if(s)delete levels[s.groups.id];else if(n){let e=party.findIndex(e=>e.id===n.groups.id&&!0===e.inParty);if(e>=0){let t=document.querySelector(`[name="${e}-${compareSame(parseInt(n.groups.ability,16))}"]`);t&&t.use()}}}}),addOverlayListener("PartyChanged",e=>{party=e.party,e.party.length&&(party=[party.find(e=>e.id===charID&&e.inParty),...partySort(party.filter(e=>e.id!==charID&&e.inParty))]),handle()}),startOverlayEvents(),document.addEventListener("onOverlayStateUpdate",e=>e.detail.isLocked?document.querySelector("#readMe").setAttribute("hidden",!0):document.querySelector("#readMe").removeAttribute("hidden")),document.querySelector("#settings").onclick=(()=>{window.open("./settings.html","_blank","width=1280,height=720")}),document.querySelector("#showFake").onclick=(()=>{party=[{id:"10000027",name:"PLD",worldId:1177,job:19,inParty:!0},{id:"10000030",name:"NIN",worldId:1169,job:30,inParty:!0},{id:"10000028",name:"SCH",worldId:1179,job:28,inParty:!0},{id:"10000022",name:"DRG",worldId:1043,job:22,inParty:!0},{id:charID||"10000021",name:"TEST",worldId:1177,job:38,inParty:!0},{id:"10000020",name:"MNK",worldId:1045,job:20,inParty:!0},{id:"10000033",name:"AST",worldId:1179,job:33,inParty:!0},{id:"10000025",name:"BLM",worldId:1177,job:25,inParty:!0}],handle()}),document.querySelector("#clear").onclick=(()=>{party=[],handle()});