"use strict";function load(e,t=""){return loadItem(namespace,e,t)}function save(e,t){saveItem(namespace,e,t)}function partySort(e){let t=[];return settings.partySort["when"+jobList.find(t=>t.ID.toString()===e.find(e=>e.id!==charID).job.toString()).Role].split(">").forEach(e=>t.push(...settings.partySort[e])),e.sort((e,s)=>parseInt(t.indexOf(baseClass[e.job].toString()))-parseInt(t.indexOf(baseClass[s.job].toString())))}function handle(){document.querySelector("main").innerHTML="";for(let e=0;e<party.length;e++){const t=party[e];void 0===t||t.id===charID&&"True"===settings.style.hideYourself||settings.watchs.find(e=>e.job===t.job.toString()).watch.forEach(s=>{let r=actions.find(e=>e.ID===s.id),n=document.createElement("article");n.style.position="absolute",n.style.top=.8*(parseFloat(s.top)+e*(50+parseFloat(settings.style.ySpace)))*settings.style.scale+"px",n.style.right=parseFloat(s.right)*(1+settings.style.xSpace/100)*.8*settings.style.scale+"px",n.style.width="48px",n.style.height=n.style.width,n.style.lineHeight=n.style.width,n.style.transform=`scale(${.8*s.scale*settings.style.scale})`,setTimeout(()=>{"TRUE"!==r.IsRoleAction&&parseInt(r.ClassJobLevel)>parseInt(levels[t.id])&&(n.style.opacity="0.5")},1e3),n.style.fontSize=settings.style.fontSize+"px",n.setAttribute("name",e+"-"+r.ID);let i=r.Recast100ms instanceof Function?r.Recast100ms(levels[t.id]?levels[t.id]:0)/10:r.Recast100ms/10;n.setAttribute("reset100ms",i);let a=r.MaxCharges instanceof Function?r.MaxCharges(levels[t.id]?levels[t.id]:0):r.MaxCharges;n.style.background=`\n        url(),\n        url(./resources/${settings.style.skin}.png),\n        url(https://cafemaker.wakingsands.com/i/${r.Url}.png) center / 40px 40px no-repeat `,a>0&&(n.innerText=a,n.style.textShadow="-1px 0 3px rgb(197, 73, 0), 0 1px 3px rgb(197, 73, 0), 1px 0 3px rgb(197, 73, 0), 0 -1px 3px rgb(197, 73, 0)",n.style.fontSize=.8*parseInt(n.style.fontSize)+"px",n.style.padding="15px 0px 0px 30px"),n.use=function(){if("true"===settings.ttsOn&&TTS(settings.tts[r.ID]),n.style.opacity="1","0"===a){clearInterval(n.timer);let e=`url(./resources/${settings.style.skin+r.ActionCategory}.png)`,t=n.style.background.split(",");t[0]=`${e} 0px 0px/ 432px 432px`,n.style.background=t.join(",");let s=i;n.timer=setInterval(()=>{let r=1-s/i,a=Math.floor(81*r%9),l=Math.floor(9*r);8!==a||8!==l?(s-=settings.style.refreshRate/1e3,n.innerText=Math.round(s),t[0]=`${e} ${-48*a}px ${-48*l}px / 432px 432px`,n.style.background=t.join(",")):(clearInterval(n.timer),n.innerText="",t[0]="url()",n.style.background=t.join(","))},settings.style.refreshRate)}else{n.innerText=parseInt(n.innerText)-1;let e=n.style.background.split(",");e[1]=`url(./resources/${"0"!==n.innerText?settings.style.skin:"0charges"}.png)`,n.style.background=e.join(","),n.style.color="0"===n.innerText?"rgb(255,100,100)":"white";let t=i;n.timer||(n.timer=setInterval(()=>{let s=1-t/i,r=Math.floor(81*s%9),l=Math.floor(9*s);8!==r||8!==l?(t-=settings.style.refreshRate/1e3,e[0]=`url(./resources/charges.png) ${-48*r}px ${-48*l}px / 432px 432px`,e[1]=`url(./resources/${"0"!==n.innerText?settings.style.skin:"0charges"}.png)`,n.style.background=e.join(",")):(clearInterval(n.timer),n.timer=void 0,n.innerText=parseInt(n.innerText)+1,e[0]="url(./resources/charges.png) 0px 0px/ 432px 432px",e[1]=`url(./resources/${"0"!==n.innerText?settings.style.skin:"0charges"}.png)`,n.style.background=e.join(","),n.innerText===a?e[1]=`url(./resources/${settings.style.skin}.png)`:(n.innerText=parseInt(n.innerText)+1,n.use()))},settings.style.refreshRate))}},document.querySelector("main").appendChild(n)})}}import{loadItem,saveItem}from"../../../resources/localStorage.min.js";import{TTS}from"../../../resources/TTS.js";import{actions}from"./actions.min.js";import{compareSame}from"./compareSameGroup.min.js";import{defaultSettings}from"./defaultSettings.min.js";import{jobList}from"./job.min.js";window.onerror=function(){alert(`遇到了意料之外的错误。\n${JSON.stringify(arguments,null,2)}`)};let settings,namespace="TeamWatch3",baseClass={1:19,2:20,3:21,4:22,5:23,6:24,7:25,26:27,29:30,19:19,21:21,32:32,37:37,24:24,28:28,33:33,20:20,22:22,30:30,34:34,23:23,31:31,38:38,25:25,27:27,35:35,36:36},charID="10000021",party=[],levels={};(function(){function e(e){let t=[];for(const s in e){e[s].reverse();let r={};r.job=s;let n=[],i=0;for(const t of e[s])""!==t&&n.push({id:t,scale:"1",top:"0px",right:44*i+"px"}),i++;r.watch=n,t.push(r)}return t}settings=Object.assign(JSON.parse(JSON.stringify(defaultSettings)),load("settings",{})),settings.style=Object.assign(JSON.parse(JSON.stringify(defaultSettings)).style,load("settings",{}).style);let t=localStorage.getItem("teamWatch");if(t&&!localStorage.getItem("TeamWatch3")){console.log("从旧版本中继承了数据"),t=JSON.parse(t),settings=Object.assign(JSON.parse(JSON.stringify(defaultSettings)),{watchs:e(t.watch)});try{settings.ttsOn=t.TTSOn||settings.ttsOn,settings.tts=t.TTS||settings.tts}catch{}save("settings",settings)}})(),addOverlayListener("ChangePrimaryPlayer",e=>charID=e.charID.toString(16).toUpperCase()),addOverlayListener("onLogEvent",e=>{for(const t of e.detail.logs){let e=t.match(/^.{15}03:(?<id>1.{7}):Added new combatant .+? Job:.+? Level: (?<level>\d+) Max HP/),s=t.match(/^.{15}04:(?<id>1.{7}):/),r=t.match(/^.{15}1[56]:(?<id>1.{7}):[^:]+:(?<ability>[^:]+):.+:0$/);if(e)levels[e.groups.id]=e.groups.level;else if(s)delete levels[s.groups.id];else if(r){let e=party.findIndex(e=>e.id===r.groups.id&&!0===e.inParty);if(e>=0){let t=document.querySelector(`[name="${e}-${compareSame(parseInt(r.groups.ability,16))}"]`);t&&t.use()}}}}),addOverlayListener("PartyChanged",e=>{party=e.party,e.party.length&&(party=[party.find(e=>e.id===charID&&e.inParty),...partySort(party.filter(e=>e.id!==charID&&e.inParty))]),handle()}),startOverlayEvents(),document.addEventListener("onOverlayStateUpdate",e=>e.detail.isLocked?document.querySelector("#readMe").setAttribute("hidden",!0):document.querySelector("#readMe").removeAttribute("hidden")),document.querySelector("#settings").onclick=(()=>{window.open("./settings.html","_blank","width=1280,height=720")}),document.querySelector("#showFake").onclick=(()=>{party=[{id:"10000027",name:"PLD",worldId:1177,job:19,inParty:!0},{id:"10000030",name:"NIN",worldId:1169,job:30,inParty:!0},{id:"10000028",name:"SCH",worldId:1179,job:28,inParty:!0},{id:"10000022",name:"DRG",worldId:1043,job:22,inParty:!0},{id:charID||"10000021",name:"TEST",worldId:1177,job:38,inParty:!0},{id:"10000020",name:"MNK",worldId:1045,job:20,inParty:!0},{id:"10000033",name:"AST",worldId:1179,job:33,inParty:!0},{id:"10000025",name:"BLM",worldId:1177,job:25,inParty:!0}],party=[party.find(e=>e.id===charID&&e.inParty),...partySort(party.filter(e=>e.id!==charID&&e.inParty))],handle()}),document.querySelector("#clear").onclick=(()=>{party=[],handle()});