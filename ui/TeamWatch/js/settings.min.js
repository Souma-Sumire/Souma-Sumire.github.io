"use strict";function load(e,t=""){return loadItem(namespace,e,t)}function save(e,t){saveItem(namespace,e,t)}function convertOldWatchs(e){let t=[];for(const n in e){e[n].reverse();let l={};l.job=n;let a=[],s=0;for(const t of e[n])""!==t&&a.push({id:t,scale:"1",top:"0px",right:44*s+"px"}),s++;l.watch=a,t.push(l)}return t}function insertTTS(e,t){if(!parseInt(e)>0)return;let n=document.createElement("div");n.classList.add("ttsSkill"),n.innerText=actions.find(t=>t.ID===e)[`Name_${settings.language}`];let l=document.createElement("input");l.setAttribute("type","text"),l.value=t,l.title=e,n.appendChild(l);let a=document.createElement("button");a.innerHTML="X",a.onclick=function(){this.parentNode.remove()},n.appendChild(a),document.querySelector("#tts").insertBefore(n,document.getElementById("ttsPlus"))}function insertWatch(e,t,n){""===e.style.transform&&(e.style.transform="scale(1)"),e.style.width="48px",e.style.height=e.style.width,e.style.lineHeight=e.style.height,e.style.background=`url(./resources/${settings.style.skin}.png),url(${settings.style.url}${t.Url}.png) center / 40px 40px no-repeat `,e.title=t["Name_"+settings.language],e.setAttribute("name",t.ID),e.setAttribute("draggable","true"),e.ondragstart=function(e){pos.x=e.x,pos.y=e.y,pos.right=this.style.right,pos.top=this.style.top;let t=document.createElement("img");e.dataTransfer.setDragImage(t,0,0),e.dataTransfer.effectAllowed="move"},e.ondrag=function(e){let t=this.style.transform.replace(/[^0-9\.]/gi,""),n=document.querySelector("#stepInput").value*t;this.style.right=Math.min(Math.max(Math.round((parseInt(pos.right)-parseInt(e.x-pos.x))/n)*n,0),document.body.clientWidth-150)+"px",this.style.top=Math.min(Math.max(Math.round((parseInt(pos.top)+parseInt(e.y-pos.y))/n)*n,0),44*(1-t))+"px"},n.ondragover=(e=>e.preventDefault()),e.ondragend=function(e){let t=this.style.transform.replace(/[^0-9\.]/gi,""),n=document.querySelector("#stepInput").value*t;this.style.right=Math.min(Math.max(Math.round((parseInt(pos.right)-parseInt(e.x-pos.x))/n)*n,0),document.body.clientWidth-150)+"px",this.style.top=Math.min(Math.max(Math.round((parseInt(pos.top)+parseInt(e.y-pos.y))/n)*n,0),44*(1-t))+"px"};let l=document.createElement("aside");l.innerText="X",l.onclick=function(){let e=confirm(`要删除${l.parentNode.title}吗？`);e&&this.parentNode.remove()};let a=document.createElement("button");a.innerText="S",a.style.height="16px",a.style.lineHeight="10px",a.style.width="16px",a.style.position="absolute",a.style.bottom="4px",a.style.left="1px",a.style.fontSize="12px",a.onclick=function(){e.style.transform="scale(0.5)",e.style.top="0px"};let s=document.createElement("button");s.innerText="L",s.style.height="16px",s.style.lineHeight="10px",s.style.width="16px",s.style.position="absolute",s.style.bottom="4px",s.style.left="31px",s.style.fontSize="12px",s.onclick=function(){e.style.transform="scale(1)",e.style.top="0px"},e.appendChild(a),e.appendChild(s),e.appendChild(l),n.appendChild(e)}import{loadItem,saveItem}from"../../../resources/localStorage.min.js";import{actions}from"./actions.min.js";import{compareSameGroup}from"./compareSameGroup.min.js";import{defaultSettings}from"./defaultSettings.min.js";import{jobList}from"./job.min.js";import{language}from"./language.min.js";import"../../../resources/jquery-3.6.0.min.js";import"../../../resources/drag-arrange.min.js";let namespace="TeamWatch3";window.onerror=function(){alert(`遇到了意料之外的错误。\n${JSON.stringify(arguments,null,2)}`)};let settings=Object.assign(defaultSettings,load("settings",{}),{share:{}}),old=localStorage.getItem("teamWatch");old&&!localStorage.getItem("TeamWatch3")&&(console.log(language.loadOldSettings[settings.language]),old=JSON.parse(old),settings=Object.assign(defaultSettings,{watchs:convertOldWatchs(old.watch)}),settings.ttsOn=old.TTSOn||settings.ttsOn,settings.tts=old.TTS||settings.tts,settings.style.fontSize=old.settings.fontSize||settings.style.fontSize,save("settings",settings));let nav=document.createElement("ul"),skinList={"默认":"default","Material UI MOD":"material"},urlList={cafemaker:"https://cafemaker.wakingsands.com/i/",XIVAPI:"https://xivapi.com/i/"};for(const e in settings){if("ttsOn"===e||void 0===language[e])continue;let t=document.createElement("li");t.title=e,language[e]&&(t.innerText=language[e][settings.language]||e),t.onclick=(()=>{for(const e of document.querySelectorAll("main>article"))e.style.display="none";document.querySelector(`#${t.title}`).style.display="block";for(const e of document.querySelectorAll("nav>ul>li"))e.style.fontWeight="normal";t.style.fontWeight="bold"}),nav.appendChild(t);let n=document.createElement("article");n.id=e,document.querySelector("main").appendChild(n)}document.querySelector("nav").appendChild(nav);let styleOptions=document.createElement("ul");for(const e in settings.style){let t=document.createElement("li");if(void 0!==language[e]){let n;if(t.innerText=language[e][settings.language],isNaN(settings.style[e])){if(n=document.createElement("select"),n.title=e,"skin"===e)for(const e in skinList){let t=document.createElement("option");t.value=skinList[e],t.innerText=e,n.appendChild(t)}else if("url"===e)for(const e in urlList){let t=document.createElement("option");t.value=urlList[e],t.innerText=e,n.appendChild(t)}n.value=settings.style[e]}else switch(n=document.createElement("input"),n.setAttribute("type","number"),n.onkeypress=(()=>/[\d\.]/.test(String.fromCharCode(event.keyCode))),n.title=e,n.value=settings.style[e],e){case"fontSize":n.setAttribute("min","12");break;case"xSpace":n.setAttribute("min","-50"),n.setAttribute("max","50"),n.onkeypress=(()=>!1);break;case"ySpace":n.setAttribute("min","-44"),n.setAttribute("max","44"),n.onkeypress=(()=>!1);break;case"refreshRate":n.setAttribute("step","37")}t.appendChild(n),styleOptions.appendChild(t)}}document.querySelector("#style").appendChild(styleOptions);let stepInputText=document.createElement("span");stepInputText.innerText=language.stepInputText[settings.language],document.querySelector("#watchs").appendChild(stepInputText);let stepInput=document.createElement("input");stepInput.setAttribute("type","number"),stepInput.setAttribute("step","0.5"),stepInput.value=22,stepInput.id="stepInput",document.querySelector("#watchs").appendChild(stepInput);let watchOptions=document.createElement("ul"),pos={};[...settings.partySort.Tank,...settings.partySort.Healer,...settings.partySort.Dps,"1","2","3","4","5","6","7","26","29"].forEach(e=>{const t=settings.watchs.find(t=>t.job===e);let n=document.createElement("li");n.innerText=jobList.find(e=>e.ID===t.job)[settings.language],n.style.height="50px",n.style.lineHeight=n.style.height,n.style.outline="gray dashed 1px",n.style.width=40*t.length+"px",n.style.position="relative",n.title=t.job;for(const e of t.watch){let t=actions.find(t=>t.ID===e.id);if(void 0===t)console.log(`${e.id}未找到，已跳过`);else{let l=document.createElement("article");l.style.position="absolute",l.style.top=e.top,l.style.right=e.right,l.style.transform=`scale(${e.scale})`,insertWatch(l,t,n)}}n.style.paddingLeft="0.5em";let l=document.createElement("button");l.innerText="+",l.style.marginLeft="1em",l.style.padding="0.375em 0.75em",l.setAttribute("name",jobList.find(e=>e.ID===t.job).cn),l.onclick=function(){let e=document.querySelector("#watchs > ul > li > div");e&&e.remove();let t=document.createElement("div");t.style.height=n.style.height,t.style.width="300px",t.style.left="8em",t.style.top="0px",t.style.position="absolute";let a=document.createElement("select");for(const e of actions.filter(e=>new RegExp(`(^| )${l.getAttribute("name")}($| )`).test(e.ClassJobCategory)))if(void 0===compareSameGroup[e.ID]&&void 0===[].slice.call(n.querySelectorAll("article")).find(t=>t.getAttribute("name")===(compareSameGroup[e.ID]||e.ID))){let t=document.createElement("option");t.innerText=e[`Name_${settings.language}`],t.setAttribute("value",e.ID),a.appendChild(t)}t.appendChild(a);let s=document.createElement("button");s.innerText=language.add[settings.language];let o=document.createElement("button");o.innerText=language.cancel[settings.language],t.appendChild(s),s.onclick=function(){let e=actions.find(e=>e.ID===this.parentNode.querySelector("select").value),t=document.createElement("article");t.style.position="absolute",t.style.top="0px";let l=[].slice.call(n.querySelectorAll("article")).reduce((e,t)=>parseInt(e.style.right)>parseInt(t.style.right)?e:t,{style:{right:-44}});t.style.right=parseInt(l.style.right)+44+"px",insertWatch(t,e,n),o.onclick()},t.appendChild(o),o.onclick=function(){this.parentNode.remove()},n.appendChild(t)},n.appendChild(l),watchOptions.appendChild(n)}),document.querySelector("#watchs").appendChild(watchOptions);let div=document.createElement("div"),ttsOnBtn=document.createElement("input");ttsOnBtn.setAttribute("type","checkbox"),ttsOnBtn.checked="true"===settings.ttsOn,div.appendChild(ttsOnBtn);let ttsOnText=document.createElement("span");ttsOnText.innerText=language.ttsOnText[settings.language],div.appendChild(ttsOnText),document.querySelector("#tts").appendChild(div);for(const e in settings.tts)if(Object.hasOwnProperty.call(settings.tts,e)){const t=settings.tts[e];insertTTS(e,t)}let ttsAdd=document.createElement("button");ttsAdd.id="ttsPlus",ttsAdd.innerText="+",ttsAdd.onclick=function(){if(document.querySelector("#ttsAddSelect"))return;let e=document.createElement("div");e.id="ttsAddSelect";let t=document.createElement("input");t.setAttribute("placeholder",language.searchSkill[settings.language]),t.onchange=function(){n.innerHTML="",actions.filter(e=>-1!==e.Name_cn.indexOf(this.value)||-1!==e.Name_en.indexOf(this.value)||-1!==e.Name_jp.indexOf(this.value)).forEach(e=>{let t=document.createElement("option");t.innerText=e[`Name_${settings.language}`],t.value=e.ID,n.appendChild(t)})};let n=document.createElement("select");for(const e of actions){if(compareSameGroup[e.ID])continue;let t=document.createElement("option");t.innerText=e[`Name_${settings.language}`],t.value=e.ID,n.appendChild(t)}let l=document.createElement("button");l.innerText=language.add[settings.language],l.onclick=function(){insertTTS(n.value,""),e.remove()};let a=document.createElement("button");a.innerText=language.cancel[settings.language],a.onclick=function(){e.remove()},e.style.position="absolute",e.style.top=1*ttsAdd.offsetTop+40+"px",e.style.left=ttsAdd.offsetLeft+"px",e.appendChild(t),e.appendChild(n),e.appendChild(l),e.appendChild(a),ttsAdd.parentNode.appendChild(e)},document.querySelector("#tts").appendChild(ttsAdd);{let e=document.createElement("div");e.id="jobSort";let t=["Tank>Healer>Dps","Tank>Dps>Healer","Healer>Tank>Dps","Healer>Dps>Tank","Dps>Healer>Tank","Dps>Tank>Healer"],n=["Tank","Healer","Dps"],l=["jobSortTank","jobSortHealer","jobSortDps"];for(const n of l){let l=document.createElement("span");l.innerText=language[n][settings.language],e.appendChild(l);let a=document.createElement("select");for(const e of t){let t=document.createElement("option");t.value=e,t.innerText=e,a.appendChild(t)}a.title=`when${n.replace("jobSort","")}`,a.value=settings.partySort[`when${n.replace("jobSort","")}`],e.appendChild(a)}document.querySelector("#partySort").appendChild(e);for(const e of n){let t=document.createElement("ul");t.classList.add(e);for(const n of settings.partySort[e]){let e=document.createElement("li"),l=document.createElement("p");l.innerText=jobList.find(e=>e.ID===n.toString())[settings.language],l.classList.add("drag"),l.style.height="100%",l.style.width="100%",e.appendChild(l),e.setAttribute("name",n),t.appendChild(e)}document.querySelector("#partySort").appendChild(t)}$("#partySort > ul.Tank > li").arrangeable({dragSelector:".drag"}),$("#partySort > ul.Healer > li").arrangeable({dragSelector:".drag"}),$("#partySort > ul.Dps > li").arrangeable({dragSelector:".drag"})}{let e=document.createElement("select"),t=["cn","en","jp"];for(const n of t){let t=document.createElement("option");t.value=n,t.innerText=n,e.appendChild(t)}e.title="language",e.style.width="5em",e.style.padding="25px",e.style.margin="25px",e.style.fontSize="25px",e.value=settings.language,document.querySelector("#language").appendChild(e)}{let e=document.createElement("p"),t=document.createElement("button"),n=document.createElement("textarea");n.id="shareInInput",t.innerText=language.shareIn[settings.language],e.appendChild(n),e.appendChild(t);let l=document.createElement("p"),a=document.createElement("button"),s=document.createElement("textarea");s.id="shareOutInput",a.innerText=language.shareOut[settings.language],l.appendChild(s),l.appendChild(a),document.querySelector("#share").appendChild(e),document.querySelector("#share").appendChild(l),t.onclick=(()=>{try{let e=JSON.parse(window.decodeURIComponent(window.atob(document.querySelector("#shareInInput").value)));e[1]instanceof Array?save("settings",Object.assign(defaultSettings,{watchs:convertOldWatchs(e)})):save("settings",e),location.reload()}catch{document.querySelector("#shareInInput").value="格式错误"}}),a.onclick=(()=>{document.querySelector("#shareOutInput").value=window.btoa(window.encodeURIComponent(JSON.stringify(settings)))})}document.querySelector("#save").innerHTML=language.save[settings.language],document.querySelector("#save").onclick=function(){document.querySelectorAll("#style>ul>li>input").forEach(e=>settings.style[e.title]=e.value),document.querySelectorAll("#style>ul>li>select").forEach(e=>settings.style[e.title]=e.value),document.querySelectorAll("#watchs>ul>li").forEach(e=>{let t=[];e.querySelectorAll("article").forEach(e=>t.push({id:e.getAttribute("name"),scale:e.style.transform.replace(/[^0-9\.]/gi,""),top:e.style.top,right:e.style.right})),settings.watchs.find(t=>t.job===e.title).watch=t}),settings.ttsOn=document.querySelector("#tts > div:nth-child(1) > input[type=checkbox]").checked.toString();let e={};document.querySelectorAll("#tts>div.ttsSkill>input").forEach(t=>e[t.title]=t.value),settings.tts=e,document.querySelectorAll("#partySort>#jobSort>select").forEach(e=>settings.partySort[e.title]=e.value),document.querySelectorAll("#partySort>ul").forEach(e=>{let t=[];e.querySelectorAll("li").forEach(e=>t.push(e.getAttribute("name"))),settings.partySort[e.className]=t}),settings.language=document.querySelector("#language > select").value,save("settings",settings),location.reload(),window.opener&&window.opener.location.reload()},document.querySelector("nav>ul>li:nth-of-type(1)").onclick();