"use strict";import{status}from"../../../resources/status.js";import{loadItem,saveItem}from"../../../resources/localStorage.min.js";import{def}from"./def.js";document.addEventListener("onOverlayStateUpdate",e=>e.detail.isLocked?$("#readMe").hide():$("#readMe").show()),$(function(){function e(e,a=""){return loadItem(t,e,a)}function a(e,a){saveItem(t,e,a)}function i(e){function a(e){let a=e.indexOf(" ");return a>=0?`${e.substring(0,1)}. ${e.substring(a+1,a+2)}.`:e}function i(e,a="target"){let i,s={inParty:!1,isEnemy:!1};if("target"===a)i=0;else{if("caster"!==a)return s;i=-4}switch(e.line[0]){case"21":case"22":i+=7;break;case"26":case"30":i+=8;break;default:return s}s.inParty=e.line[i]===o;for(const a of d)s.inParty||(s.inParty=a.name===e.line[i]&&a.inParty);return s.isEnemy="4"===e.line[i-1].substring(0,1),s}function t(e,a,i=!1){if(l[e]){let s="";for(const t in l[e])Object.hasOwnProperty.call(l[e],t)&&(s+=`<span class="icons"><img class="${i?"icons-offset":""} ${m[t].physics&&"physics"===a||m[t].magic&&"magic"===a||"dodge"===a||"darkness"===a&&m[t].physics&&m[t].magic?"useful":"useless"}" title="${l[e][t].name}" src="https://cafemaker.wakingsands.com/i/${status[parseInt(t,16)].url}"></span>`);return s}return""}switch(e.line[0]){case"21":case"22":if(i(e).inParty&&i(e,"caster").isEnemy){let i=s(e);if("damage"===i.type&&"Unknown_"!==i.skillName.substring(0,8)){let e=`main>dl:last[title="${i.skillName}"]`;$("main").children("dl").length>=parseInt(n.cacheMax)&&$("main").children(":first").remove(),0===$(e).length&&($("main>dl:last-child>dd").hide(),$("main").append(`<dl title="${i.skillName}"><dt style="background-color:${n.color.dtColor}" onclick="dtClick(this)"><span class="damage-time">${p}</span><span class="damage-target player-name">${a(i.target)}</span><span class="damage-name">${i.skillName}</span><span style="color:${n.color[`${i.damageType}Color`]}" class="damage-value"></span><span class="status"></span></dt></dl>`)),i.target===o&&($(`${e}>dt>.damage-time`).text(p),$(`${e}>dt>.damage-target`).text(a(i.target)),$(`${e}>dt>.damage-name`).text(i.skillName),$(`${e}>dt>.damage-value`).text(i.value.toLocaleString()),$(`${e}>dt>.status`).html(t(i.from,i.damageType,!0)+t(i.target,i.damageType))),$(`${e}`).append(`<dd onclick="ddClick(this)" style="background-color:${n.color.ddColor}" ${$(`${e}>dd:last`).is(":hidden")?"hidden":""}><span class="damage-time">${p}</span><span class="damage-target player-name">${i.target}</span><span class="damage-name">${i.skillName}</span><span style="color:${n.color[`${i.damageType}Color`]}"  class="damage-value">${i.value.toLocaleString()}</span><span class="damage-effect">${i.damageEffect}</span><span class="status">${t(i.from,i.damageType,!0)+t(i.target,i.damageType)}</span></dd>`),$(".player-name").css("filter",`blur(${c?2:0}px)`),$("html").scrollTop($("main").height())}}break;case"26":if((i(e).inParty||i(e).isEnemy)&&m[e.line[2]]){l[e.line[8]]||(l[e.line[8]]={}),r[e.line[8]]||(r[e.line[8]]={}),l[e.line[8]][e.line[2]]={name:e.line[3],from:e.line[6]},clearTimeout(r[e.line[8]][e.line[2]]),r[e.line[8]][e.line[2]]=setTimeout(()=>{l&&l[e.line[8]][e.line[2]]&&delete l[e.line[8]][e.line[2]]},parseInt(1e3*e.line[4])+500);break}case"30":(i(e).inParty||i(e).isEnemy)&&l[e.line[8]]&&(clearTimeout(r[e.line[8]][e.line[2]]),l&&l[e.line[8]][e.line[2]]&&delete l[e.line[8]][e.line[2]])}}function s(e){function a(){switch(e.line[8].substr(e.line[8].length-3,1)){case"1":return"暴击";case"2":return"直击";case"3":return"直暴";default:return"　　"}}let i={type:"unknown",damageType:"unknown",damageEffect:"未知",skillName:e.line[5],skillID:e.line[4],value:0,from:e.line[3],target:e.line[7]};if(/^.{0,7}1$/.test(e.line[8]))i.type="damage",i.damageType="dodge",i.damageEffect="回避";else if(/^[^fF].{0,3}[1-4].{2}(33|.[356])$/.test(e.line[8]))i.type="damage",i.damageType="physics",i.damageEffect=a();else if(/^[^fF].{0,3}5.{4}$/.test(e.line[8]))i.type="damage",i.damageType="magic",i.damageEffect=a();else if(/^[^fF].{0,3}6.{4}$/.test(e.line[8]))i.type="damage",i.damageType="darkness",i.damageEffect=a();else if(/^[^fF].{0,3}1.{0,3}4$/.test(e.line[8]))i.type="heal",i.damageType="heal",i.damageEffect="暴击";else{if(!/^[^fF].{0,7}4$/.test(e.line[8]))return i;i.type="heal",i.damageType="heal",i.damageEffect="　　"}let s=e.line[9].padStart(8,"0");if("4"!==s[4])i.value=parseInt(s.substring(0,4),16);else{let e="0x"+s.substring(2,4),a="0x"+s.substring(6,8);i.value=parseInt(a.substring(2,4)+s.substring(0,2)+(e-a).toString(16).toUpperCase(),16)}return i}let t="keigenRecord",c=e("blurName",!1),n=e("settings",0)||def;$("#goSettings").on("click",()=>{let a=window.open("./settings.html","_blank","width=358, height=355"),i=setInterval(()=>{a.closed&&(clearInterval(i),n=e("settings",0)||def)},500)});let l={},m={"4a7":{physics:1,magic:1},740:{physics:1,magic:1},496:{physics:1,magic:1},"4a":{physics:1,magic:1},498:{physics:1,magic:1},52:{physics:1,magic:1},"2df":{physics:1,magic:1},"8b3":{physics:1,magic:1},57:{physics:1,magic:1},59:{physics:1,magic:1},199:{physics:1,magic:1},"49a":{physics:1,magic:1},"2ea":{physics:0,magic:1},"2eb":{physics:1,magic:1},766:{physics:0,magic:1},"32a":{physics:1,magic:1},811:{physics:1,magic:1},730:{physics:1,magic:1},728:{physics:1,magic:1},"72a":{physics:1,magic:1},"72f":{physics:0,magic:1},"72c":{physics:1,magic:1},751:{physics:1,magic:1},"12b":{physics:1,magic:1},"13d":{physics:0,magic:1},753:{physics:0,magic:1},351:{physics:1,magic:1},"4b6":{physics:1,magic:1},"4d0":{physics:1,magic:1},"49b":{physics:1,magic:1},"78e":{physics:1,magic:1},"79f":{physics:1,magic:1},722:{physics:1,magic:1},"2d7":{physics:1,magic:1},"4c2":{physics:1,magic:1},"5b1":{physics:1,magic:1},129:{physics:1,magic:1},"77d":{physics:1,magic:1},345:{physics:1,magic:1},758:{physics:1,magic:1},761:{physics:1,magic:1},"1e8":{physics:1,magic:1},a8:{physics:1,magic:1},790:{physics:1,magic:1},"76a":{physics:1,magic:1},"4b9":{physics:1,magic:0},"4a9":{physics:1,magic:1},"4ab":{physics:1,magic:0},"4b3":{physics:0,magic:1},848:{physics:1,magic:1},"6b3":{physics:1,magic:1},843:{physics:0,magic:1},"9c4":{physics:1,magic:1},"6ba":{physics:1,magic:1},"9c0":{physics:1,magic:1},847:{physics:1,magic:1},"6b7":{physics:1,magic:1},842:{physics:1,magic:1}},r=[],d=[];addOverlayListener("PartyChanged",e=>{d=e.party});let g,o="",p="00:00";addOverlayListener("ChangePrimaryPlayer",e=>o=e.charName),addOverlayListener("CombatData",e=>{$("main").show(),$("#hover").hide(),p=e.Encounter.duration,clearTimeout(g),g=setTimeout(()=>{$("main").hide(),$("#hover").show()},1e3*parseInt(n.autoHideS))}),$("#hover").on("click",()=>{$("main").show(),$("html").scrollTop($("main").height()),$("#hover").hide()}),$("html").on("mouseleave",()=>{clearTimeout(g),g=setTimeout(()=>{$("main").hide(),$("#hover").show()},1e3*parseInt(n.autoHideS))}),addOverlayListener("ChangeZone",()=>{l={};for(const e of r)for(const a of e)clearTimeout(a)}),addOverlayListener("onPartyWipe",()=>{l={};for(const e of r)for(const a of e)clearTimeout(a)}),addOverlayListener("LogLine",e=>i(e)),startOverlayEvents(),window.dtClick=(e=>$($(e).siblings("dd")[0]).is(":hidden")?$(e).siblings("dd").show():$(e).siblings("dd").hide()),window.ddClick=function(e){let a=`${$(e).children(".damage-time").text()} ${$(e).children(".damage-target").text()} ${$(e).children(".damage-name").text()} ${$(e).children(".damage-value").text()} `;for(let i=0;i<$(e).find("img").length;i++)a+=$(e).find("img")[i].title+" ";$("#toCopy").val(a),document.getElementById("toCopy").select(),document.execCommand("copy"),$("#hint").remove();let i=$('<div id="hint">已复制！</div>');i.css({position:"sticky",bottom:"10px",width:"100%",backgroundColor:"rgba(255,255,255,0.4)","text-align":"center"}),i.stop(),i.animate({opacity:1},1e3),i.animate({opacity:0},1500),$("body").append(i)},$("html").on("contextmenu",()=>{c=!c,$(".player-name").css("filter",`blur(${c?2:0}px)`),a("blurName",c)})});