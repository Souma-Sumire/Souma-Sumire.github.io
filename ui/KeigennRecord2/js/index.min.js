"use strict";function addFooter(){document.querySelector("body > footer > ul").innerHTML=`<li class="select" data-object-id="${youID}" data-select="true" data-job-name="YOU" data-reality-name="YOU">YOU</li>`,party.length&&document.querySelector("body > footer > ul").append(...party.filter(t=>t.id!==youID).map(t=>{let e=document.createElement("li");return e.setAttribute("data-reality-name",t.name),e.setAttribute("data-job-name",(jobList.find(e=>e.ID.toString()===t.job.toString())||{cn:"未知"}).cn),e.appendChild(document.createTextNode(e.getAttribute("data-job-name"))),e.setAttribute("data-object-id",t.id),e.setAttribute("data-select","false"),e})),document.querySelectorAll("body > footer > ul > li ").forEach(t=>{t.onclick=function(){document.querySelectorAll("body > footer > ul > li ").forEach(t=>{t.setAttribute("data-select","false"),t.classList.remove("select")}),this.setAttribute("data-select","true"),t.classList.add("select"),document.querySelectorAll("body > main > table > tbody > tr:not(:nth-child(1))").forEach(e=>e.style.display=e.getAttribute("data-master-id")===t.getAttribute("data-object-id")?"table-row":"none")},t.oncontextmenu=(()=>document.querySelectorAll("body > footer > ul > li ").forEach(t=>t.innerText=t.innerText===t.getAttribute("data-reality-name")?t.getAttribute("data-job-name"):t.getAttribute("data-reality-name")))})}import{jobList}from"../../../resources/data/job.js";import{status}from"../../../resources/data/status.js";import{logProcessing}from"../../../resources/data/logProcessing.js";import{getDamage}from"../../../resources/function/damage.js";import{keigenn}from"../data/keigenn.js";let party=[],youID="",duration="00:00",FFXIVObject={},scrollMove=!0;class FFObject{constructor(t,e){this.ID=t,this.Name=e,this.Status={}}}addOverlayListener("ChangePrimaryPlayer",t=>{youID=t.charID.toString(16).toUpperCase(),addFooter()}),addOverlayListener("PartyChanged",t=>{party=t.party.filter(t=>t.inParty),addFooter()}),addOverlayListener("CombatData",t=>duration=t.Encounter.duration),addOverlayListener("ChangeZone",()=>{FFXIVObject={},document.querySelector("body > main > table > tbody").innerHTML="<tr></tr>"}),addOverlayListener("onPartyWipe",()=>{FFXIVObject={},document.querySelector("body > main > table > tbody").insertRow(-1).insertCell(0).innerHTML="团灭"}),addOverlayListener("LogLine",t=>{function e(){return"4"===r.casterID.substring(0,1)&&(party.some(t=>t.id===r.targetID&&t.inParty)||r.targetID===youID)}function a(){return party.some(t=>t.id===r.targetID&&t.inParty)||r.targetID===youID||"4"===r.targetID.substring(0,1)}let r;switch(t.line[0]){case"21":case"22":if(r=logProcessing(t.line,"action"),e(t.line)){let e=document.querySelector("body > main > table > tbody").insertRow(-1);e.setAttribute("data-master-id",r.targetID),e.setAttribute("data-master-name",r.targetName),e.style.display="true"===document.querySelector(`body > footer > ul > li[data-object-id="${r.targetID}"]`).getAttribute("data-select")?"table-row":"none";let a=getDamage(t);e.insertCell(0).innerHTML=duration,e.insertCell(1).innerHTML=r.actionName;let n=e.insertCell(2);n.innerHTML=a.value,n.setAttribute("data-damage-effect",a.damageEffect),n.title=a.from,n.classList.add(a.damageType);let i=e.insertCell(3);function o(t,e,a,o){let n=document.createElement("img");n.setAttribute("src",`https://cafemaker.wakingsands.com/i/${status[parseInt(e,16)].url}`),n.title=FFXIVObject[r[t]].Status[e].name,"0"===keigenn[e][a.damageType]&&n.classList.add("useless"),o.appendChild(n)}if(FFXIVObject[r.targetID])for(const t in FFXIVObject[r.targetID].Status)o("targetID",t,a,i);if(FFXIVObject[r.casterID])for(const t in FFXIVObject[r.casterID].Status)o("casterID",t,a,i);scrollMove&&"true"===document.querySelector(`body > footer > ul > li[data-object-id="${r.targetID}"]`).getAttribute("data-select")&&(document.querySelector("body > main").scrollTop=document.querySelector("body > main").scrollHeight),e.onclick=(()=>{let t=[];t.push(e.children[0].innerHTML),t.push(e.children[2].title),t.push(e.children[1].innerHTML),t.push(e.getAttribute("data-master-name")),t.push(e.children[2].innerHTML);for(const a of e.children[3].children)t.push(a.title);document.querySelector("#toCopy").value=t.join(" "),document.querySelector("#toCopy").select(),document.execCommand("copy"),document.querySelector("#hint").innerText="已复制！",document.querySelector("#hint").classList.add("anim-opacity2"),setTimeout(()=>{document.querySelector("#hint").classList.remove("anim-opacity2")},2e3)})}break;case"26":r=logProcessing(t.line,"status"),keigenn[r.statusID]&&a(t.line)&&(FFXIVObject[r.targetID]=FFXIVObject[r.targetID]||new FFObject(r.targetID,r.targetName),FFXIVObject[r.targetID].Status[r.statusID]={name:r.statusName,caster:r.casterName});break;case"30":if(r=logProcessing(t.line,"status"),keigenn[r.statusID]&&a(t.line))try{delete FFXIVObject[r.targetID].Status[r.statusID]}catch{}}}),startOverlayEvents(),document.querySelector("main").onscroll=(t=>scrollMove=document.querySelector("main").scrollHeight-282-t.target.scrollTop<5);