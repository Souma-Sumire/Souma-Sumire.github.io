"use strict";function load(e,t=""){return loadItem(namespace,e,t)}function save(e,t){saveItem(namespace,e,t)}function insertTTS(e,t){let n=document.createElement("div");n.classList.add("ttsSkill"),n.innerText=actions.find(t=>t.ID===e)[`Name_${settings.language}`];let l=document.createElement("input");l.setAttribute("type","text"),l.value=t,l.title=e,n.append(l),document.querySelector("#tts").insertBefore(n,document.getElementById("ttsPlus"))}function insertWatch(e,t,n){e.style.transform=`scale(${settings.style.scale})`,e.style.width=48*settings.style.iconSize/settings.style.iconSize+"px",e.style.height=e.style.width,e.style.lineHeight=e.style.height,e.style.background=`url(./resources/${settings.style.skin}.png),url(${settings.style.url}${t.Url}.png) center / 40px 40px no-repeat `,e.title=t["Name_"+settings.language],e.setAttribute("name",t.ID),e.setAttribute("draggable","true"),e.ondragstart=function(e){pos.x=e.x,pos.y=e.y,pos.right=this.style.right,pos.top=this.style.top;let t=document.createElement("img");e.dataTransfer.setDragImage(t,0,0),e.dataTransfer.effectAllowed="move"};let l=22;e.ondrag=function(e){this.style.right=Math.min(Math.max(Math.round((parseInt(pos.right)-parseInt(e.x-pos.x))/l)*l,0),document.body.clientWidth-150)+"px",this.style.top=Math.min(Math.max(Math.round((parseInt(pos.top)+parseInt(e.y-pos.y))/l)*l,0-.5*(1-this.style.transform.replace(/[^0-9\.]/gi,""))*parseInt(settings.style.iconSize)),40-settings.style.iconSize*this.style.transform.replace(/[^0-9\.]/gi,""))+"px"},n.ondragover=(e=>e.preventDefault()),e.ondragend=function(e){this.style.right=Math.min(Math.max(Math.round((parseInt(pos.right)-parseInt(e.x-pos.x))/l)*l,0),document.body.clientWidth-150)+"px",this.style.top=Math.min(Math.max(Math.round((parseInt(pos.top)+parseInt(e.y-pos.y))/l)*l,0-.5*(1-this.style.transform.replace(/[^0-9\.]/gi,""))*parseInt(settings.style.iconSize)),40-settings.style.iconSize*this.style.transform.replace(/[^0-9\.]/gi,""))+"px"};let a=document.createElement("aside");a.innerText="X",a.onclick=function(){let e=confirm(`要删除${a.parentNode.title}吗？`);e&&this.parentNode.remove()};let s=document.createElement("button");s.innerText="S",s.style.height="16px",s.style.lineHeight="10px",s.style.width="16px",s.style.position="absolute",s.style.bottom="4px",s.style.left="1px",s.style.fontSize="12px",s.onclick=function(){e.style.transform="scale(0.5)",e.style.top="0px"};let i=document.createElement("button");i.innerText="L",i.style.height="16px",i.style.lineHeight="10px",i.style.width="16px",i.style.position="absolute",i.style.bottom="4px",i.style.left="31px",i.style.fontSize="12px",i.onclick=function(){e.style.transform="scale(1)",e.style.top="0px"},e.appendChild(s),e.appendChild(i),e.appendChild(a),n.appendChild(e)}import{loadItem,saveItem}from"../../../resources/localStorage.min.js";import{actions}from"./actions.min.js";import{compareSameGroup}from"./compareSameGroup.min.js";import{defaultSettings}from"./defaultSettings.min.js";import{jobList}from"./job.min.js";import{language}from"./language.min.js";let namespace="TeamWatch3",settings=Object.assign(defaultSettings,load("settings",{}),{share:{}}),nav=document.createElement("ul"),skinList={"默认":"default","Material UI MOD":"material"},urlList={cafemaker:"https://cafemaker.wakingsands.com/i/",XIVAPI:"https://xivapi.com/i/"};for(const e in settings){let t=document.createElement("li");t.title=e,t.innerText=language[e][settings.language]||e,t.onclick=(()=>{for(const e of document.querySelectorAll("main>article"))e.style.display="none";document.querySelector(`#${t.title}`).style.display="block";for(const e of document.querySelectorAll("nav>ul>li"))e.style.fontWeight="normal";t.style.fontWeight="bold"}),nav.appendChild(t);let n=document.createElement("article");n.id=e,document.querySelector("main").appendChild(n)}document.querySelector("nav").appendChild(nav);let styleOptions=document.createElement("ul");for(const e in settings.style){let t,n=document.createElement("li");if(n.innerText=language[e]?language[e][settings.language]:e,isNaN(settings.style[e])){if(t=document.createElement("select"),"skin"===e)for(const e in skinList){let n=document.createElement("option");n.value=skinList[e],n.innerText=e,t.appendChild(n)}else if("url"===e)for(const e in urlList){let n=document.createElement("option");n.value=urlList[e],n.innerText=e,t.appendChild(n)}}else t=document.createElement("input"),t.setAttribute("type","number"),t.title=e,t.value=settings.style[e];n.appendChild(t),styleOptions.appendChild(n)}document.querySelector("#style").appendChild(styleOptions);let watchOptions=document.createElement("ul"),pos={};for(const e in settings.watchs){const t=settings.watchs[e];let n=document.createElement("li");n.innerText=jobList.find(e=>e.ID===t.job)[settings.language],n.style.height=(1*settings.style.iconSize+1*settings.style.ySpace)*settings.style.scale+"px",n.style.lineHeight=n.style.height,n.style.outline="gray dashed 1px",n.style.width=settings.style.iconSize*settings.style.scale*t.length+"px",n.style.position="relative",n.title=t.job;for(const e of t.watch){let t=actions.find(t=>t.ID===e.id),l=document.createElement("article");l.style.position="absolute",l.style.top=e.top,l.style.right=e.right,insertWatch(l,t,n)}n.style.paddingLeft="0.5em";let l=document.createElement("button");l.innerText="+",l.style.marginLeft="1em",l.style.padding="0.375em 0.75em",l.setAttribute("name",jobList.find(e=>e.ID===t.job).cn),l.onclick=function(){let e=document.querySelector("#watchs > ul > li > div");e&&e.remove();let t=document.createElement("div");t.style.height=n.style.height,t.style.width="300px",t.style.left="8em",t.style.top="0px",t.style.position="absolute";let a=document.createElement("select");for(const e of actions.filter(e=>new RegExp(`(^| )${l.getAttribute("name")}($| )`).test(e.ClassJobCategory)))if(void 0===compareSameGroup[e.ID]&&void 0===[].slice.call(n.querySelectorAll("article")).find(t=>t.getAttribute("name")===(compareSameGroup[e.ID]||e.ID))){let t=document.createElement("option");t.innerText=e[`Name_${settings.language}`],t.setAttribute("value",e.ID),a.appendChild(t)}t.appendChild(a);let s=document.createElement("button");s.innerText=language.add[settings.language];let i=document.createElement("button");i.innerText=language.cancel[settings.language],t.appendChild(s),s.onclick=function(){let e=actions.find(e=>e.ID===this.parentNode.querySelector("select").value),t=document.createElement("article");t.style.position="absolute",t.style.top="0px";let l=[].slice.call(n.querySelectorAll("article")).reduce((e,t)=>parseInt(e.style.right)>parseInt(t.style.right)?e:t);t.style.right=parseInt(l.style.right)+parseInt(settings.style.iconSize)+4+"px",insertWatch(t,e,n),i.onclick()},t.appendChild(i),i.onclick=function(){this.parentNode.remove()},n.appendChild(t)},n.appendChild(l),watchOptions.appendChild(n)}document.querySelector("#watchs").appendChild(watchOptions);for(const e in settings.tts)if(Object.hasOwnProperty.call(settings.tts,e)){const t=settings.tts[e];insertTTS(e,t)}let ttsAdd=document.createElement("button");ttsAdd.id="ttsPlus",ttsAdd.innerText="+",ttsAdd.onclick=function(){if(document.querySelector("#ttsAddSelect"))return;let e=document.createElement("div");e.style.display="inline-block",e.id="ttsAddSelect";let t=document.createElement("select");for(const e of actions){if(compareSameGroup[e.ID])continue;let n=document.createElement("option");n.innerText=e[`Name_${settings.language}`],n.value=e.ID,t.appendChild(n)}let n=document.createElement("button");n.innerText=language.add[settings.language],n.onclick=function(){insertTTS(t.value,""),e.remove()};let l=document.createElement("button");l.innerText=language.cancel[settings.language],l.onclick=function(){e.remove()},e.style.position="relative",e.style.left="-245px",e.style.bottom="-30px",e.appendChild(t),e.appendChild(n),e.appendChild(l),ttsAdd.parentNode.appendChild(e)},document.querySelector("#tts").appendChild(ttsAdd);{let e=document.createElement("div");e.id="jobSort";let t=["Tank>Healer>Dps","Tank>Dps>Healer","Healer>Tank>Dps","Healer>Dps>Tank","Dps>Healer>Tank","Dps>Tank>Healer"],n=["Tank","Healer","Dps"],l=["jobSortTank","jobSortHealer","jobSortDps"];for(const n of l){let l=document.createElement("span");l.innerText=language[n][settings.language],e.appendChild(l);let a=document.createElement("select");for(const e of t){let t=document.createElement("option");t.value=e,t.innerText=e,a.appendChild(t)}a.title=`when${n.replace("jobSort","")}`,a.value=settings.partySort[`when${n.replace("jobSort","")}`],e.appendChild(a)}document.querySelector("#partySort").appendChild(e);let a=null,s=null;for(const e of n){let t=document.createElement("ul");t.classList.add(e);for(const n of settings.partySort[e]){let e=document.createElement("li");e.innerText=jobList.find(e=>e.ID===n.toString())[settings.language],e.setAttribute("name",n),e.setAttribute("draggable","true"),e.ondragstart=function(e){s=e.path[1].classList.value,a=e.target,e.dataTransfer.setData("text/html",e.target.innerHTML)},e.ondrop=function(e){a!=e.target&&s===e.path[1].classList.value&&(a.innerHTML=e.target.innerHTML,e.target.innerHTML=e.dataTransfer.getData("text/html"))},e.ondragover=(e=>{e.preventDefault()}),t.appendChild(e)}document.querySelector("#partySort").appendChild(t)}}{let e=document.createElement("select"),t=["cn","en","jp"];for(const n of t){let t=document.createElement("option");t.value=n,t.innerText=n,e.appendChild(t)}e.title="language",e.style.width="5em",e.style.padding="25px",e.style.margin="25px",e.style.fontSize="25px",e.value=settings.language,document.querySelector("#language").appendChild(e)}{let e=document.createElement("p"),t=document.createElement("button"),n=document.createElement("textarea");n.id="shareInInput",t.innerText=language.shareIn[settings.language],e.appendChild(n),e.appendChild(t);let l=document.createElement("p"),a=document.createElement("button"),s=document.createElement("textarea");s.id="shareOutInput",a.innerText=language.shareOut[settings.language],l.appendChild(s),l.appendChild(a),document.querySelector("#share").appendChild(e),document.querySelector("#share").appendChild(l),t.onclick=(()=>{try{save("settings",JSON.parse(window.decodeURIComponent(window.atob(document.querySelector("#shareInInput").value)))),location.reload()}catch{document.querySelector("#shareInInput").value="格式错误"}}),a.onclick=(()=>{document.querySelector("#shareOutInput").value=window.btoa(window.encodeURIComponent(JSON.stringify(settings)))})}document.querySelector("#save").innerHTML=language.save[settings.language],document.querySelector("#save").onclick=function(){document.querySelectorAll("#style>ul>li>input").forEach(e=>settings.style[e.title]=e.value),document.querySelectorAll("#watchs>ul>li").forEach(e=>{let t=[];e.querySelectorAll("article").forEach(e=>t.push({id:e.getAttribute("name"),scale:e.style.transform.replace(/[^0-9\.]/gi,""),top:e.style.top,right:e.style.right})),settings.watchs.find(t=>t.job===e.title).watch=t});let e={};document.querySelectorAll("#tts>div>input").forEach(t=>e[t.title]=t.value),settings.tts=e,document.querySelectorAll("#partySort>#jobSort>select").forEach(e=>settings.partySort[e.title]=e.value),document.querySelectorAll("#partySort>ul").forEach(e=>{let t=[];e.querySelectorAll("li").forEach(e=>t.push(e.getAttribute("name"))),settings.partySort[e.getAttribute("name")]=t}),settings.language=document.querySelector("#language > select").value,save("settings",settings),location.reload(),window.opener.location.reload()},document.querySelector("nav>ul>li:nth-of-type(1)").onclick();